<html>
<head>
<meta charset="utf-8">
<title>PDP11 Emulator with UNIX V6</title>
<script type="text/javascript" src="utility/JsImport.js"></script>
<script type="text/javascript" src="pdp11/Import.js"></script>
<script type="text/javascript" src="pdp11/TextAreaView.js"></script>
<script type="text/javascript">

var __pdp11 ;
var __unixV6DiskImageURL = 'https://pdp11-js.googlecode.com/git/disk_image/v6bin' ;
var __terminalView ;
var __debugView ;
var __debugOn ;
var __debugCanvas ;
var __figureWindow ;


/**
 * TODO: maybe better to change the function name
 */
var dragOver = function( event ) {
  event.preventDefault( ) ;
} ;


/**
 * TODO: appropriate error message.
 */
var dropDiskImage = function( event ) {

  event.preventDefault( ) ;
  var file = event.dataTransfer.files[ 0 ] ;

  var reader = new FileReader( ) ;
  reader.onload = function( event ) {
    initPdp11( event.target.result ) ;
  } ;
  reader.onerror = function( e ) {
    __terminalView.outputLine( 'Error!' ) ;
    for( var key in reader.error ) {
      __terminalView.output( key + '=' + reader.error[ key ] + '<br />' ) ;
    }
  } ;
  reader.readAsArrayBuffer( file ) ;
  __terminalView.outputLine( 'loading image...' ) ;

} ;


/**
 * TODO: appropriate error message.
 */
var loadUnixV6DiskImage = function( ) {
  var request = new XMLHttpRequest( ) ;
  request.responseType = 'arraybuffer' ;
  request.onload = function( ) {
    initPdp11( request.response ) ;
  } ;
  request.onerror = function( e ) {
    __terminalView.outputLine( 'Error!' ) ;
  } ;
  request.open( 'GET', __unixV6DiskImageURL, true ) ;
  request.send( null ) ;
  __terminalView.outputLine( 'loading image...' ) ;
} ;


/**
 * @param buffer ArrayBuffer including Disk image
 */
var initPdp11 = function( buffer ) {
  document.getElementById( 'loadV6Button' ).disabled = true ;
  document.getElementById( 'exportButton' ).disabled = false ;
  document.getElementById( 'resetButton' ).disabled = false ;
  document.getElementById( 'stopButton' ).disabled = false ;
  document.getElementById( 'stopButton' ).textContent = 'stop' ;

  __terminalView.focus( ) ;

  __pdp11 = new Pdp11( __terminalView, __debugCanvas ) ;
  __pdp11.disk.importBuffer( buffer ) ;
  changeDebugFlags( ) ;
  __pdp11.loadBootRom( buffer ) ;
  __pdp11.run( ) ;
} ;


/**
 * TODO: make it run as specification
 */
var resetPdp11 = function( ) {
  if( __pdp11 )
    initPdp11( __pdp11.disk.exportBuffer( ) ) ;
} ;


/**
 * TODO: optimize
 */
var exportDiskImage = function( ) {
  var span = document.getElementById( 'diskImageSpan' ) ;
  while( span.firstChild )
    span.removeChild( span.firstChild )
  var buffer = __pdp11.disk.exportBuffer( ) ;
  var a = document.createElement( 'a' ) ;
  a.download = 'v6bin' ;
  a.href = window.URL.createObjectURL( new Blob( [ new Uint8Array( buffer ) ] ) ) ;
  a.textContent = 'disk image' ;
  span.appendChild( a ) ;
} ;


/**
 * TODO: implement
 */
var stopPdp11 = function( ) {
  if( ! __pdp11 )
    return ;
  var button = document.getElementById( 'stopButton' ) ;
  if( button.textContent == 'stop' ) {
    __pdp11.stop = true ;
    button.textContent = 'restart' ;
  } else {
    __pdp11.stop = false ;
    button.textContent = 'stop' ;
    __pdp11.run( ) ;
  }
} ;


/**
 *
 */
var init = function( ) {
  document.getElementById( 'exportButton' ).disabled = true ;
  document.getElementById( 'resetButton' ).disabled = true ;
  document.getElementById( 'stopButton' ).disabled = true ;
  __terminalView = new TextAreaView( 'terminalView' ) ;
  __debugView = new LimitedLinesTextAreaView( 'debugView' ) ;
  document.getElementById( 'instructionCheck' ).disabled = true ;
  document.getElementById( 'kernelSymbolCheck' ).disabled = true ;
  __debugCanvas = document.getElementById( 'debugCanvas' ) ;
  displayInitialMessage( ) ;
} ;


/**
 *
 */
var changeDebugState = function( flag ) {
  var span = document.getElementById( 'debugSpan' ) ;
  __debugOn = flag ;
  if( flag ) {
    span.style.cssText = '' ;
    changeDebugFlags( ) ;
  } else {
    span.style.cssText = 'display: none' ;
    __debugView.clear( ) ;
    if( __pdp11 ) {
      for( var key in __pdp11.debugFlags ) {
        __pdp11.debugFlags[ key ] = false ;
      }
    }
  }
} ;


/**
 *
 */
var changeDebugFlags = function( ) {
  if( ! __pdp11 || ! __debugOn )
    return ;
  for( var key in __pdp11.debugFlags ) {
    __pdp11.debugFlags[ key ] = document.getElementById( key + 'Check' ).checked ;
  }
} ;


/**
 *
 */
var inputTerminal = function( e ) {
  var keyCode = e.keyCode ;

  if( keyCode >= 0x41 && keyCode <= 0x5a && ! e.shiftKey ) {
    keyCode += 0x20 ;
  }
  if( __pdp11 )
    __pdp11.terminal.input( keyCode ) ;
  e.preventDefault( ) ;
} ;


/**
 *
 */
var displayInitialMessage = function( ) {
  __terminalView.outputLine( 'Drag and drop your UNIX V6 disk image here or' ) ;
  __terminalView.outputLine( 'press the "load UNIX V6 Disk image" button to run UNIX V6.' ) ;
  __terminalView.outputLine( '' ) ;
  __terminalView.outputLine( 'Type "rkunix" slowly (\'cuz some reasons) when "@" is displayed.' ) ;
  __terminalView.outputLine( 'And then, type "root" when "login: " is displayed.' ) ;
  __terminalView.outputLine( '' ) ;
  __terminalView.outputLine( 'Note that, use "#" instead of backspace.' ) ;
  __terminalView.outputLine( 'And use "chdir" instead of "cd".' ) ;
  __terminalView.outputLine( '' ) ;
  __terminalView.outputLine( 'I confirmed only it runs on the combination of Windows and Chrome.' ) ;
  __terminalView.outputLine( '' ) ;
  __terminalView.outputLine( '           ' +
                            'Enjoy UNIX V6 on your web browser! -- Takahiro(@superhoge)' ) ;
  __terminalView.outputLine( '' ) ;
} ;


/**
 * 
 */
var flushLog = function( ) {
  if( __logger.getUrl == undefined )
    return ;
  var span = document.getElementById( 'traceLogSpan' ) ;
  while( span.firstChild )
    span.removeChild( span.firstChild )
  var a = document.createElement( 'a' ) ;
  a.download = 'log' ;
  a.href = __logger.getUrl( ) ;
  a.textContent = 'log' ;
  span.appendChild( a ) ;
} ;

window.addEventListener( 'drop', dropDiskImage, false ) ;
window.addEventListener( 'dragover', dragOver, false ) ;

</script>
</head>

<body onLoad="init( )">

<p>
<ul>
<li>Introduction
 <ul>
 <li>This is the PDP11 emulator with JavaScript implemented by <a href="https://twitter.com/superhoge">takahiro(@superhoge)</a></li>
 <li>You can run UNIX V6 on your web browser.</li>
 <li><a href="http://d.hatena.ne.jp/takahirox/20130801/1375334305">See this page for the detail.</a></li>
 <li><a href="http://www.youtube.com/watch?v=CsSPiM07amg">This is the demonstration video</a></li>
 <li><a href="http://d.hatena.ne.jp/takahirox/20121214/1355490840">If you wanna study UNIX V6 kernel...</a></li>
 </ul>
</li>
<li>UNIX V6 Tips
 <ul>
 <li>Type "rkunix" slowly ('cuz some reasons) when "@" is displayed.</li>
 <li>Type "root" when "login: " is displayed.</li>
 <li>Use "#" instead of backspace.</li>
 <li>Use "chdir" instead of "cd".</li>
 <li>Use "ed" to edit a file.</li>
 </ul>
</li>
</ul>
</p>

<p>
<button id="loadV6Button" onclick="loadUnixV6DiskImage( )">load UNIX V6 Disk image</button>
<button id="exportButton" onclick="exportDiskImage( )">export Disk image</button>
<button id="resetButton" onclick="resetPdp11( )">reset</button>
<button id="stopButton" onclick="stopPdp11( )">stop</button>
<span id="diskImageSpan"></span>
<span id="traceLogSpan"></span>
</p>

<p>
<textarea id="terminalView" cols="80" rows="20" readonly="readonly" onkeypress="inputTerminal( event )"> </textarea>
</p>

<p>
debug (under construction)
<input type="checkbox" id="debug" onchange="changeDebugState( this.checked )" />
</p>

<span id="debugSpan" style="display: none">
<p>
instruction
<input type="checkbox" id="instructionCheck" onclick="changeDebugFlags( )" />
trap
<input type="checkbox" id="trapCheck" onclick="changeDebugFlags( )" />
interrupt
<input type="checkbox" id="interruptCheck" onclick="changeDebugFlags( )" />
system call
<input type="checkbox" id="systemCallCheck" onclick="changeDebugFlags( )" checked/>
kernel symbol
<input type="checkbox" id="kernelSymbolCheck" onclick="changeDebugFlags( )" />
</p>

<p>
<textarea id="debugView" cols="80" rows="20" readonly="readonly"> </textarea>
<canvas id="debugCanvas" width="50" height="300" />
</p>

</span>

</body>
</html>
