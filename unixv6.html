<html>
<head>
<meta charset="utf-8">
<title>file</title>
<script type="text/javascript" src="utility/JsImport.js"></script>
<script type="text/javascript" src="pdp11/Import.js"></script>
<script type="text/javascript" src="pdp11/TextAreaView.js"></script>
<script type="text/javascript">

var pdp11 ;
var __unixV6DiskImageURL = 'https://pdp11-js.googlecode.com/git/disk_image/v6bin' ;
var __terminalView ;
var __debugView ;
var __debugOn ;
var __debugCanvas ;
var __figureWindow ;

// TODO: maybe better to change the function name;
var dragOver = function( event ) {
  event.preventDefault( ) ;
} ;

var dropDiskImage = function( event ) {

  event.preventDefault( ) ;
  var file = event.dataTransfer.files[ 0 ] ;

  var reader = new FileReader( ) ;
  reader.onload = function( event ) {
    initPdp11( event.target.result ) ;
  } ;
  reader.onerror = function( e ) {
    __terminalView.outputLine( 'Error!' ) ;
    for( var key in reader.error ) {
      __terminalView.output( key + '=' + reader.error[ key ] + '<br />' ) ;
    }
  } ;
  reader.readAsArrayBuffer( file ) ;
  __terminalView.outputLine( 'loading image...' ) ;

} ;

var loadUnixV6DiskImage = function( ) {
  var request = new XMLHttpRequest( ) ;
  request.responseType = 'arraybuffer' ;
  request.onload = function( ) {
    initPdp11( request.response ) ;
  } ;
  request.onerror = function( e ) {
    __terminalView.outputLine( 'Error!' ) ;
  } ;
  request.open( 'GET', __unixV6DiskImageURL, true ) ;
  request.send( null ) ;
  __terminalView.outputLine( 'loading image...' ) ;
} ;

// TODO: optimize
var exportDiskImage = function( ) {
  var view = document.getElementById( 'diskImage' ) ;
  while( view.firstChild )
    view.removeChild( view.firstChild )

  var buffer = pdp11.disk.exportBuffer( ) ;
  var blob = new Blob( [ new Uint8Array( buffer ) ] ) ;
  var a = document.createElement( 'a' ) ;
  a.download = 'v6bin' ;
  a.href = window.URL.createObjectURL( blob ) ;
  a.textContent = 'disk image' ;
  view.appendChild( a ) ;
//  open( window.URL.createObjectURL( blob ), false ) ;
} ;

var initPdp11 = function( buffer ) {
  document.getElementById( 'loadV6Button' ).disabled = true ;
  document.getElementById( 'exportButton' ).disabled = false ;
  document.getElementById( 'resetButton' ).disabled = false ;
  document.getElementById( 'stopButton' ).disabled = false ;
  document.getElementById( 'stopButton' ).textContent = 'stop' ;

  __terminalView.focus( ) ;

  pdp11 = new Pdp11( __terminalView, __debugCanvas ) ;
  pdp11.disk.importBuffer( buffer ) ;
  changeDebugFlags( ) ;
  pdp11.loadBootRom( buffer ) ;
  pdp11.run( ) ;
} ;

// TODO: make it run as specification
var resetPdp11 = function( ) {
  if( pdp11 )
    initPdp11( pdp11.disk.exportBuffer( ) ) ;
} ;

var init = function( ) {
  document.getElementById( 'exportButton' ).disabled = true ;
  document.getElementById( 'resetButton' ).disabled = true ;
  document.getElementById( 'stopButton' ).disabled = true ;
  __terminalView = new TextAreaView( 'terminalView' ) ;
  __debugView = new LimitedLinesTextAreaView( 'debugView' ) ;
  document.getElementById( 'instructionCheck' ).disabled = true ;
  document.getElementById( 'kernelSymbolCheck' ).disabled = true ;
  __debugCanvas = document.getElementById( 'debugCanvas' ) ;
  displayInitialMessage( ) ;
} ;

var displayInitialMessage = function( ) {
  __terminalView.outputLine( 'Drag and drop your UNIX V6 disk image here or' ) ;
  __terminalView.outputLine( 'press the "load UNIX V6 Disk image" button to run UNIX V6.' ) ;
  __terminalView.outputLine( '' ) ;
  __terminalView.outputLine( 'Type "rkunix" slowly (\'cuz some reasons) when "@" is displayed.' ) ;
  __terminalView.outputLine( 'And then, type "root" when "login: " is displayed.' ) ;
  __terminalView.outputLine( '' ) ;
  __terminalView.outputLine( 'Note that, use "#" instead of backspace.' ) ;
  __terminalView.outputLine( 'And use "chdir" instead of "cd".' ) ;
  __terminalView.outputLine( '' ) ;
  __terminalView.outputLine( 'I confirmed only it runs on the combination of Windows and Chrome.' ) ;
  __terminalView.outputLine( '' ) ;
  __terminalView.outputLine( '           ' +
                            'Enjoy UNIX V6 on your web browser! -- Takahiro(@superhoge)' ) ;
  __terminalView.outputLine( '' ) ;
} ;

// TODO: implement
var stopPdp11 = function( ) {
  if( ! pdp11 )
    return ;
  var button = document.getElementById( 'stopButton' ) ;
  if( button.textContent == 'stop' ) {
    pdp11.stop = true ;
    button.textContent = 'restart' ;
  } else {
    pdp11.stop = false ;
    button.textContent = 'stop' ;
    pdp11.run( ) ;
  }
} ;

var lognum_change = function( ) {
  __logview.setAttribute( "rows", parseInt( __lognum.selectedOptions.item( ).value ) + 1 ) ;
} ;

var loglevel_change = function( ) {
  __logger.setLevel( parseInt( __loglevel.selectedOptions.item( ).value ) ) ;
} ;

var changeDebugState = function( flag ) {
  var view = document.getElementById( 'debugArea' ) ;
  __debugOn = flag ;
  if( flag ) {
    view.style.cssText = '' ;
    changeDebugFlags( ) ;
  } else {
    view.style.cssText = 'display: none' ;
    __debugView.clear( ) ;
    if( pdp11 ) {
      for( var key in pdp11.debugFlags ) {
        pdp11.debugFlags[ key ] = false ;
      }
    }
  }
} ;

var changeDebugFlags = function( ) {
  if( ! pdp11 || ! __debugOn )
    return ;
  for( var key in pdp11.debugFlags ) {
    pdp11.debugFlags[ key ] = document.getElementById( key + 'Check' ).checked ;
  }
} ;

var inputTerminal = function( e ) {
  var keyCode = e.keyCode ;

  if( keyCode >= 0x41 && keyCode <= 0x5a && ! e.shiftKey ) {
    keyCode += 0x20 ;
  }
  if( pdp11 )
    pdp11.terminal.input( keyCode ) ;
//  console.log( format( keyCode ) + ':' + String.fromCharCode( keyCode & 0x7f ) ) ;
  e.preventDefault( ) ;
} ;

window.addEventListener( 'drop', dropDiskImage, false ) ;
window.addEventListener( 'dragover', dragOver, false ) ;

</script>
</head>

<body onLoad="init( )">

<p><a href="http://d.hatena.ne.jp/takahirox/20121214/1355490840">If you wanna study UNIX V6 kernel...</a></p>

<p>
<button id='loadV6Button' onclick='loadUnixV6DiskImage( )'>load UNIX V6 Disk image</button>
<button id='exportButton' onclick="exportDiskImage( )">export Disk image</button>
<button id='resetButton' onclick="resetPdp11( )">reset</button>
<button id='stopButton' onclick="stopPdp11( )">stop</button>
<span id='diskImage'></span>
<span id='traceLog'></span>
</p>

<p>
<textarea id="terminalView" cols="80" rows="20" readonly="readonly" onkeypress='inputTerminal( event )'> </textarea>
</p>

<p>
debug (under construction) <input type='checkbox' id='debug' onchange='changeDebugState( this.checked )' />
</p>

<span id='debugArea' style='display: none'>
<p>
instruction
<input type='checkbox' id='instructionCheck' onclick='changeDebugFlags( )' />
trap
<input type='checkbox' id='trapCheck' onclick='changeDebugFlags( )' />
interrupt
<input type='checkbox' id='interruptCheck' onclick='changeDebugFlags( )' />
system call
<input type='checkbox' id='systemCallCheck' onclick='changeDebugFlags( )' checked/>
kernel symbol
<input type='checkbox' id='kernelSymbolCheck' onclick='changeDebugFlags( )' />
</p>

<p>
<textarea id="debugView" cols="80" rows="20" readonly="readonly"> </textarea>
<canvas id="debugCanvas" width="100" height="300" />
</p>

</span>

</body>
</html>
