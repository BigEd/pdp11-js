<html>
<head>
<meta charset="utf-8">
<title>file</title>
<script type="text/javascript" src="utility/JsImport.js"></script>
<script type="text/javascript" src="pdp11/Import.js"></script>

<script type="text/javascript" src="pdp11/object.js"></script>
<script type="text/javascript" src="pdp11/TextAreaView.js"></script>
<script type="text/javascript" src="pdp11/BinData.js"></script>
<script type="text/javascript" src="pdp11/Inode.js"></script>
<script type="text/javascript" src="pdp11/File.js"></script>
<script type="text/javascript" src="pdp11/Exe.js"></script>
<script type="text/javascript" src="pdp11/ExeHeader.js"></script>

<script type="text/javascript">

var terminal ;
var pdp11 ;
var __loglevel ;
var __unixV6DiskImageURL = 'https://pdp11-js.googlecode.com/git/disk_image/v6bin' ;
var __displayview ;

// TODO: maybe better to change the function name;
var dragOver = function( event ) {
  event.preventDefault( ) ;
} ;

var dropDiskImage = function( event ) {

  event.preventDefault( ) ;
  var file = event.dataTransfer.files[ 0 ] ;

  var reader = new FileReader( ) ;
  reader.onload = function( event ) {
    initPdp11( event.target.result ) ;
  } ;
  reader.onerror = function( e ) {
    __displayview.outputLine( 'Error!' ) ;
    for( var key in reader.error ) {
      __displayview.output( key + '=' + reader.error[ key ] + '<br />' ) ;
    }
  } ;
  reader.readAsArrayBuffer( file ) ;
  __displayview.outputLine( 'loading image...' ) ;

} ;

var loadUnixV6DiskImage = function( ) {
  var request = new XMLHttpRequest( ) ;
  request.responseType = 'arraybuffer' ;
  request.onload = function( ) {
    initPdp11( request.response ) ;
  } ;
  request.onerror = function( e ) {
    __displayview.outputLine( 'Error!' ) ;
  } ;
  request.open( 'GET', __unixV6DiskImageURL, true ) ;
  request.send( null ) ;
  __displayview.outputLine( 'loading image...' ) ;
} ;

// TODO: optimize
var exportDiskImage = function( ) {
  var buffer = pdp11.disk.exportBuffer( ) ;
  var blob = new Blob( [ new Uint8Array( buffer ) ] ) ;
  var a = document.createElement( 'a' ) ;
  a.download = 'v6bin' ;
  a.href = window.URL.createObjectURL( blob ) ;
  a.textContent = 'disk image' ;
  document.getElementsByTagName( 'body' )[ 0 ].appendChild( a ) ;
//  open( window.URL.createObjectURL( blob ), false ) ;
} ;

var initPdp11 = function( buffer ) {
  document.getElementById( 'loadV6Button' ).disabled = true ;
  document.getElementById( 'exportButton' ).disabled = false ;
  document.getElementById( 'resetButton' ).disabled = false ;
  document.getElementById( 'stopButton' ).disabled = false ;
  __displayview.focus( ) ;

  // 0xc6 : inode number of /rkunix  temporary work.
  // TODO: make the boot loader.
  var bin_data = object( BinData ).create( buffer ) ;
  var inode = object( Inode ).create( 0xc6, bin_data ) ;
  var file = object( File ).create( inode ) ;
  var exe = object( Exe ).create( file ) ;

  pdp11 = new Pdp11( ) ;
  terminal = pdp11.terminal ;
  pdp11.memory.storeBuffer( exe.buffer( ) ) ;
  pdp11.disk.importBuffer( buffer ) ;
  pdp11.setSymbols( exe.symbols( ) ) ;
  pdp11.run( ) ;
} ;

// TODO: make it run as specification
var resetPdp11 = function( ) {
  if( pdp11 )
    initPdp11( pdp11.disk.exportBuffer( ) ) ;
} ;

var init = function( ) {
  document.getElementById( 'exportButton' ).disabled = true ;
  document.getElementById( 'resetButton' ).disabled = true ;
  document.getElementById( 'stopButton' ).disabled = true ;
  __displayview = new TextAreaView( 'displayview' ) ;
  __logview = document.getElementById( "logview" ) ;
  __lognum = document.getElementById( "lognum" ) ;
  __loglevel = document.getElementById( "loglevel" ) ;
  displayInitialMessage( ) ;
} ;

var displayInitialMessage = function( ) {
  __displayview.outputLine( 'Drag and drop your UNIX V6 disk image here or' ) ;
  __displayview.outputLine( 'press the "load UNIX V6 Disk image" button to run UNIX V6.' ) ;
  __displayview.outputLine( '' ) ;
  __displayview.outputLine( 'After that, enter "root" when "login: " is displayed.' ) ;
  __displayview.outputLine( '' ) ;
  __displayview.outputLine( 'I confirmed only it runs on the combination of Windows and Chrome.' ) ;
  __displayview.outputLine( '' ) ;
  __displayview.outputLine( '           ' +
                            ' Enjoy UNIX V6 on your web browser! -- Takahiro(@superhoge)' ) ;
  __displayview.outputLine( '' ) ;
} ;

// TODO: implement
var stopPdp11 = function( ) {
  pdp11.stop = true ;
} ;

var lognum_change = function( ) {
  __logview.setAttribute( "rows", parseInt( __lognum.selectedOptions.item( ).value ) + 1 ) ;
} ;

var loglevel_change = function( ) {
  __logger.setLevel( parseInt( __loglevel.selectedOptions.item( ).value ) ) ;
} ;

var inputTerminal = function( e ) {
  var keyCode = e.keyCode ;

  if( keyCode >= 0x41 && keyCode <= 0x5a && ! e.shiftKey ) {
    keyCode += 0x20 ;
  }
  if( terminal )
    terminal.input( keyCode ) ;
//  console.log( format( keyCode ) + ':' + String.fromCharCode( keyCode & 0x7f ) ) ;
  e.preventDefault( ) ;
} ;

window.addEventListener( 'drop', dropDiskImage, false ) ;
window.addEventListener( 'dragover', dragOver, false ) ;

</script>
</head>

<body onLoad="init( )">

<p>
<button id='loadV6Button' onclick='loadUnixV6DiskImage( )'>load UNIX V6 Disk image</button>
<button id='exportButton' onclick="exportDiskImage( )">export Disk image</button>
<button id='resetButton' onclick="resetPdp11( )">reset</button>
<button id='stopButton' onclick="stopPdp11( )">stop</button>
</p>

<p>
<textarea id="displayview" cols="80" rows="20" readonly="readonly" onkeypress='inputTerminal( event )'> </textarea>
</p>


<p>
<select id="loglevel" onchange="loglevel_change( )">
<option value="1">DEBUG</option>
<option value="2">LOG</option>
<option value="3">WARN</option>
<option value="4">ERROR</option>
<option value="5" selected>NONE</option>
</select>

<select id="lognum" onchange="lognum_change( )">
<option value="1">1</option>
<option value="10">10</option>
<option value="20" selected>20</option>
<option value="40">40</option>
<option value="80">80</option>
<option value="160">160</option>
<option value="320">320</option>
<option value="640">640</option>
<option value="1280">1280</option>
</select>
</p>

<p>
<textarea id="logview" cols="80" rows="20"> </textarea>
</p>

</body>
</html>
